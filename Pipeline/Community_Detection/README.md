# Estimating spatial genome topology with Community Detection

We used Community Detection (CD) to explore spatial genome topology. CD generates clusters of cis and trans interaction frequencies, determines multi-way interactions, and visualizes the CD-derived results in genome topology maps.

#### Requirements
- python/3.8.0
  
  - Pycombo (https://pypi.org/project/pycombo/) 

- R/4.2.1


#### Input Data

To perform CD, we utilized the interaction frequency (including cis and trans) from cooler of our compendium of 62 individual Hi-C datasets (as detailed in the paper) for each interaction. WE have also analyzed different subsets (male, female, cardiovascular cells) of full compendium.  

#### Utilizing pycombo Algorithm

We implemented the pycombo algorithm, which is available through the pycombo Python package, as a non-overlapping CD algorithm.


#### Output
After the completion of the Community Detection step, each bin will be assigned a community group number. The parameters are tuned to generate 46 distinct communities, as this entity resembles diploid human genomes. Here is an example of output format:

   | ID name    | Community ID       | 
   |:--------------------------------------------------|:----------------------|
   | 6_0  | 6_1                 | 
   | 6_1  | 6_2                 |
   | 3_40  | 1                | 
   | 21_32  | 14                | 

For example, ID name 1_176 refers to the genomic region chr1:176000000-177000000. According to this example output 1_3 and 3_40 are in the same community.

## Scripts

Please execute the following three scripts in the mentioned order. First two scripts are for preparing Hi-C data for CD in a netwrok format, and the final script is for applying CD.

### 1. Run data_processing.R

In this phase, we prepared the data by converting the interaction frequencies (from cooler) for each interaction (cis and trans) across all datasets into a network format suitable for subsequent CD analysis. Please refer to the **Demo** folder for more information (including available input toy data). Here is an example of output format of one dataset:

   | ID_chrA                                                | ID_chrB        | freq     |
   |:--------------------------------------------------|:----------------------|:-----------------------|
   | 1_3       | 1_3                 | 0.509514                  |
   | 1_3 | 1_54                | 0.00311932                  |
   | 2_160   | 8_76                | 0.000281252               |


### 2. Run merge_netwroks.R

In this step, we calculate the average interaction for each interaction across all datasets. The input for this process is generated by the previous step (**data_processing.R**), and the resulting output will be presented in the same format. However, the output will be a single table containing averaged data, as opposed to individual tables for each dataset.

For additional details, please refer to the **Demo** folder.


### 3. Run CD_pycombo.py
Following data preparation, we executed the CD analysis using pycombo and set the parameters as "modularity_resolution=1.4" and "max_communities=46" (line 31) so the final result clusters nodes in 46 communities to resemble diploid (2n) genomes using pycombo. For installation guide and more information about pycombo please refer to  [https://pycombo.readthedocs.io/en/latest/](https://pypi.org/project/pycombo/).

### 4. Run construct_EdgeList.R (for visualization)

This script is intended solely for visualization purposes, as explained in the following paragraph. It constructs a chromosomal structure by connecting consecutive mapped bins. The input for this script is generated by the code in step 3 (**CD_pycombo.py**). The resulting output is a two-column table that can be used as input to Gephi for visualization. Below is an example of the output format for one dataset:

   | Source                                                | Target |
   |:--------------------------------------------------|:-----------------------|
   | 7_56       | 7_57                 |
   | 7_57 | 7_61                |
   | 7_61   | 7_62                |
   | 7_62   | 7_63                |
   

## Visualization
The results obtained through CD analysis can be effectively visualized using the following tools:

### Gephi (https://gephi.org/)
To visualize a maximum of 24 chromosomes (gonosomes and autosomes) in human diploid cells, we set the number of possible communities to 46. This resembles the human genome and allows each community to include only one chromosome’s bin if there is an intra-chromosomal domain structure isolated from the rest of the genome. For the visual representation of genome topology, we used Gephi. To reflect the results of CD and to ensure clear separation between bins from different communities, we first optimized the visualization process. We excluded inter-community interactions and plotted all bins as nodes using the ForceAtlas layout, based on intra-community Hi-C interaction weights. This step ensured that bins within each community are plotted close together and separated from other communities which facilitates the visualization of each community in the genome topology map. The distribution across the topology map as a ‘mock nucleus’ resulted in 46 distinct networks, where bins with higher interaction weights in each community were placed closer together to facilitate visualizing their interactions. Next, we added the physical connections between consecutive bins as edges in the network (using script step 4 **construct_EdgeList.R**) and optimized the network layout using the Fruchterman Reingold layout algorithm (parameters: area = 5000, gravity = 5, speed = 10). This ensured that bins within the same community remained close together and we maintain structural connections between consecutive bins across chromosomes. In the final genome topology estimation, consecutive bins were positioned next to each other to allow outlining of the chromosomal structures. Moreover, bins within the same community were as close as the physical constraints allowed.

#### Schematic overview of visualization process of CD results in genome topology maps

<img width="1063" alt="Screenshot 2024-08-01 at 12 36 05 PM" src="https://github.com/user-attachments/assets/bcaa741a-cc57-43bb-999f-ef759755c720">

Figure contains toy data for simplicity. I: Weighted network with CD results of 10 communities shows only intra-community Hi-C interactions. Inter-community interactions were removed. Each node represents a bin, and each weighted edge between two nodes depicts the Hi-C interaction weight between them. Three random communities colored in green, red, and blue are highlighted. II. Application of Force Atlas 2 optimizes the network and positions 10 communities separately. Node positions within each community are optimized independently from other communities based on their network interactions. III. Integration of chromosomal structure by removal of edges from step II and connecting consecutive bins. For example, the first bin of chromosome 6 (node 6_0) is connected to the second bin of chromosome 6 (6_1). IV. Final genome topology estimation optimized after step III using the Fruchterman Reingold method in Gephi. Edge colors represent chromosomes, and node colors indicate the same communities from the previous step. This 4-step visualization approach incorporates the results of the CD algorithm and simulates chromosomal structure by connecting consecutive bins while recapitulating the proximity of nodes within each community as much as the chromosomal structure allows.

### Helios web (https://github.com/filipinascimento/helios-web/)
Helios Web offers a web-based solution for visualizing and interpreting the results of CD in 3D.
